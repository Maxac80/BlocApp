rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // üîê HELPER FUNCTIONS
    // ============================================

    // VerificƒÉ dacƒÉ utilizatorul este autentificat
    function isAuthenticated() {
      return request.auth != null;
    }

    // VerificƒÉ dacƒÉ utilizatorul este proprietarul documentului
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // VerificƒÉ dacƒÉ utilizatorul este super_admin
    function isSuperAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }

    // VerificƒÉ dacƒÉ utilizatorul este owner al organiza»õiei
    function isOrgOwner(orgId) {
      return isAuthenticated() &&
        request.auth.uid in get(/databases/$(database)/documents/organizations/$(orgId)).data.ownerIds;
    }

    // VerificƒÉ dacƒÉ utilizatorul este membru al organiza»õiei (owner sau membru)
    function isOrgMember(orgId) {
      return isAuthenticated() && (
        isOrgOwner(orgId) ||
        exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid))
      );
    }

    // VerificƒÉ dacƒÉ utilizatorul are rol specific √Æn organiza»õie
    function hasOrgRole(orgId, roles) {
      let membership = get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data;
      return isAuthenticated() && membership.role in roles;
    }

    // VerificƒÉ dacƒÉ utilizatorul are acces la asocia»õie
    function hasAssociationAccess(assocId) {
      let assoc = get(/databases/$(database)/documents/associations/$(assocId)).data;
      return isAuthenticated() && (
        assoc.adminId == request.auth.uid ||
        request.auth.uid in assoc.ownerIds ||
        isSuperAdmin()
      );
    }

    // ============================================
    // üë§ USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Citire: propriul profil sau super_admin
      allow read: if isOwner(userId) || isSuperAdmin();

      // Creare: doar pentru propriul profil
      allow create: if isOwner(userId);

      // Update: propriul profil sau super_admin
      allow update: if isOwner(userId) || isSuperAdmin();

      // Delete: doar super_admin
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // üè¢ ORGANIZATIONS COLLECTION
    // ============================================
    match /organizations/{orgId} {
      // Citire: oricine autentificat care e membru sau owner
      allow read: if isOrgMember(orgId) || isSuperAdmin();

      // Creare: oricine autentificat (devine owner)
      allow create: if isAuthenticated();

      // Update: doar owners sau super_admin
      allow update: if isOrgOwner(orgId) || isSuperAdmin();

      // Delete: doar super_admin (soft delete prin update √Æn cod)
      allow delete: if isSuperAdmin();

      // Sub-colec»õia members
      match /members/{memberId} {
        // Citire: membrii organiza»õiei
        allow read: if isOrgMember(orgId) || isSuperAdmin();

        // Creare: owner sau admin al organiza»õiei
        allow create: if isOrgOwner(orgId) ||
          hasOrgRole(orgId, ['org_admin']) ||
          isSuperAdmin();

        // Update: owner sau admin al organiza»õiei
        allow update: if isOrgOwner(orgId) ||
          hasOrgRole(orgId, ['org_admin']) ||
          isSuperAdmin();

        // Delete: owner sau admin al organiza»õiei
        allow delete: if isOrgOwner(orgId) ||
          hasOrgRole(orgId, ['org_admin']) ||
          isSuperAdmin();
      }

      // Sub-colec»õia invitations
      match /invitations/{invitationId} {
        // Citire: oricine autentificat (pentru verificare token)
        allow read: if isAuthenticated();

        // Creare: owner sau admin al organiza»õiei
        allow create: if isOrgOwner(orgId) ||
          hasOrgRole(orgId, ['org_admin']) ||
          isSuperAdmin();

        // Update: owner sau admin, sau userul care acceptƒÉ invita»õia
        allow update: if isOrgOwner(orgId) ||
          hasOrgRole(orgId, ['org_admin']) ||
          isSuperAdmin() ||
          isAuthenticated(); // Pentru acceptare

        // Delete: owner sau admin al organiza»õiei
        allow delete: if isOrgOwner(orgId) ||
          hasOrgRole(orgId, ['org_admin']) ||
          isSuperAdmin();
      }
    }

    // ============================================
    // üè† ASSOCIATIONS COLLECTION
    // ============================================
    match /associations/{assocId} {
      // Citire: admin-ul asocia»õiei, membrii organiza»õiei pƒÉrinte, sau super_admin
      allow read: if isAuthenticated();

      // Creare: oricine autentificat
      allow create: if isAuthenticated();

      // Update: admin-ul asocia»õiei sau super_admin
      allow update: if hasAssociationAccess(assocId) || isSuperAdmin();

      // Delete: doar super_admin
      allow delete: if isSuperAdmin();

      // Sub-colec»õii asocia»õie
      match /{subcollection}/{docId} {
        allow read, write: if hasAssociationAccess(assocId) || isSuperAdmin();
      }
    }

    // ============================================
    // üìã ALTE COLEC»öII (legacy support)
    // ============================================

    // Apartments
    match /apartments/{apartmentId} {
      allow read, write: if isAuthenticated();
    }

    // Blocs
    match /blocs/{blocId} {
      allow read, write: if isAuthenticated();
    }

    // Stairs
    match /stairs/{stairId} {
      allow read, write: if isAuthenticated();
    }

    // Expenses
    match /expenses/{expenseId} {
      allow read, write: if isAuthenticated();
    }

    // Suppliers
    match /suppliers/{supplierId} {
      allow read, write: if isAuthenticated();
    }

    // Invoices
    match /invoices/{invoiceId} {
      allow read, write: if isAuthenticated();
    }

    // Sheets
    match /sheets/{sheetId} {
      allow read, write: if isAuthenticated();
    }

    // Payments
    match /payments/{paymentId} {
      allow read, write: if isAuthenticated();
    }

    // Incasari
    match /incasari/{incasareId} {
      allow read, write: if isAuthenticated();
    }

    // Owners
    match /owners/{ownerId} {
      allow read, write: if isAuthenticated();
    }

    // Audit Logs (root level)
    match /audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isSuperAdmin();
    }

    // Onboarding Progress (root level)
    match /onboarding_progress/{progressId} {
      allow read, write: if isAuthenticated();
    }

    // ============================================
    // üîí CATCH-ALL RULE (temporarily permissive)
    // Remove this in production after testing
    // ============================================
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}
